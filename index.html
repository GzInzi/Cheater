<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cheater</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body { background-color: #f0f0f0; color: #1f2937; }
      .dark body { background-color: #1f2937; color: #f9fafb; }
      .iphone-glass-effect {
        background-color: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(10px) saturate(180%);
        -webkit-backdrop-filter: blur(10px) saturate(180%);
      }
      .dark .iphone-glass-effect { background-color: rgba(31, 41, 55, 0.4); }
      .text-theme-primary { color: #1f2937; }
      .dark .text-theme-primary { color: #f9fafb; }
      .text-theme-secondary { color: #4b5563; }
      .dark .text-theme-secondary { color: #d1d5db; }
      .history-panel { max-height: 60vh; overflow-y: auto; }
      .item-checked { text-decoration: line-through; opacity: 0.6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
          const [currentView, setCurrentView] = useState('main');
          const [mode, setMode] = useState('quiz');
          const [isListening, setIsListening] = useState(false);
          const [recognition, setRecognition] = useState(null);
          const [speechText, setSpeechText] = useState('');
          const [answer, setAnswer] = useState('');
          const [isAiProcessing, setIsAiProcessing] = useState(false);
          const [apiKey, setApiKey] = useState("");
          const [statusMessage, setStatusMessage] = useState('');
          const [isDarkMode, setIsDarkMode] = useState(false);
          const [history, setHistory] = useState([]);
          const [uploadedImage, setUploadedImage] = useState(null);
          const fileInputRef = useRef(null);
          const speechTextRef = useRef('');
          
          useEffect(() => {
            const savedKey = localStorage.getItem('geminiApiKey');
            if (savedKey) setApiKey(savedKey);

            const savedTheme = localStorage.getItem('cheaterTheme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                setIsDarkMode(true);
            }

            const savedHistory = localStorage.getItem('cheaterHistory');
            if(savedHistory) setHistory(JSON.parse(savedHistory));
          }, []);

          useEffect(() => {
            if ('webkitSpeechRecognition' in window) {
              const rec = new window.webkitSpeechRecognition();
              rec.continuous = true; rec.interimResults = true; rec.lang = 'en-US';
              rec.onstart = () => setIsListening(true);
              rec.onresult = (event) => {
                let full = '';
                for (let i = 0; i < event.results.length; i++) full += event.results[i][0].transcript;
                setSpeechText(full);
              };
              rec.onerror = (e) => setIsListening(false);
              rec.onend = () => {
                setIsListening(false);
                if (speechTextRef.current.trim() || (mode === 'explain' && uploadedImage)) {
                    handleAskAI(speechTextRef.current.trim());
                }
              };
              setRecognition(rec);
            }
          }, [uploadedImage, mode]);

          useEffect(() => { speechTextRef.current = speechText; }, [speechText]);
          useEffect(() => { localStorage.setItem('cheaterHistory', JSON.stringify(history)); }, [history]);

          const toggleTheme = () => {
            const newIsDarkMode = !isDarkMode;
            setIsDarkMode(newIsDarkMode);
            document.documentElement.classList.toggle('dark', newIsDarkMode);
            localStorage.setItem('cheaterTheme', newIsDarkMode ? 'dark' : 'light');
          };

          const toggleListening = () => {
            if (!recognition) return;
            if (isListening) {
                recognition.stop();
            } else {
                setSpeechText('');
                setAnswer('');
                recognition.start();
            }
          };

          const handleImageUpload = (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => setUploadedImage(reader.result);
                reader.readAsDataURL(file);
            }
          };

          const handleAskAI = async (text, currentMode = mode) => {
            if (!text && !(currentMode === 'explain' && uploadedImage)) return;
            let keyToUse = apiKey || localStorage.getItem('geminiApiKey');
            if (!keyToUse) { setShowApiModal(true); return; }
            setIsAiProcessing(true);
            setAnswer('');
            setStatusMessage('Analyzing...');
            
            let prompt = text;
            let payload = {};
            let lastError = null;

            if (currentMode === 'explain' && uploadedImage) {
                prompt = text || "What is in this image? Explain it in detail.";
                payload = { contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: uploadedImage.split(',')[1] } }] }] };
            } else {
                 switch (currentMode) {
                    case 'quiz': prompt = `Quiz Assistant: For multiple-choice, provide ONLY the correct option. For direct questions, answer concisely. Question: "${text}"`; break;
                    case 'math': prompt = `Math Solver: Provide the final answer, then a step-by-step explanation. Problem: "${text}"`; break;
                    case 'writer': prompt = `Writing Assistant: Draft a message based on these points: "${text}"`; break;
                }
                payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            }
            
            const MAX_RETRIES = 3;
            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    if (attempt > 0) {
                        const waitMs = 1000 * (2 ** (attempt - 1));
                        setStatusMessage(`Server busy. Retrying... (${attempt}/${MAX_RETRIES - 1})`);
                        await new Promise(resolve => setTimeout(resolve, waitMs));
                    }
                    
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${keyToUse}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                    if (response.status >= 500) { throw new Error(`API error: ${response.status}`); }
                    if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error?.message || `API error: ${response.statusText}`); }

                    const result = await response.json();
                    const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    const finalAnswer = generatedText ? generatedText.trim() : "Couldn't generate a response.";
                    setAnswer(finalAnswer);
                    setHistory(prev => [{ id: Date.now(), question: text || "Image Analysis", answer: finalAnswer, mode: currentMode }, ...prev]);
                    
                    setIsAiProcessing(false);
                    setStatusMessage('');
                    return; 
                } catch (error) {
                    lastError = error;
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                }
            }
            setAnswer(lastError.toString());
            setIsAiProcessing(false);
            setStatusMessage('');
          };

          const restoreFromHistory = (item) => {
            setMode(item.mode);
            setSpeechText(item.question);
            setAnswer(item.answer);
            setCurrentView('main');
          };
          
          const clearHistory = () => {
            if(window.confirm("Are you sure you want to clear all history? This cannot be undone.")) {
                setHistory([]);
            }
          };

          const MODES = { 
            quiz: "Ask a question or read a quiz.", 
            math: "State your math problem.", 
            writer: "Dictate an email or speech.",
            explain: "Upload an image and ask about it."
          };
          const modeKeys = Object.keys(MODES);

          const MainView = () => (
            <div className="w-full h-full flex flex-col space-y-4">
                <div className="flex-shrink-0">
                    <h1 className="text-3xl font-bold text-theme-primary pt-8 sm:pt-0">Cheater</h1>
                    <div className="flex justify-center space-x-2 p-2 iphone-glass-effect rounded-xl my-4 border border-gray-400/20 dark:border-gray-600/30 overflow-x-auto">
                        {modeKeys.map(m => (
                            <button key={m} onClick={() => { setMode(m); setAnswer(''); setSpeechText(''); setUploadedImage(null); }} className={`px-4 py-2 rounded-lg text-sm font-semibold transition capitalize flex-shrink-0 ${mode === m ? 'bg-blue-500 text-white' : 'bg-white/50 text-theme-secondary dark:bg-gray-800/30'}`}>{m}</button>
                        ))}
                    </div>
                </div>

                <div className="flex-grow flex flex-col justify-center items-center space-y-4">
                    <p className="text-theme-secondary h-10 px-4">{MODES[mode]}</p>
                    
                    {mode === 'explain' ? (
                        <div className="w-full flex-grow flex flex-col items-center justify-center space-y-4">
                            <div onClick={() => fileInputRef.current.click()} className="w-full h-40 border-2 border-dashed border-gray-400/80 rounded-lg flex items-center justify-center cursor-pointer bg-white/30 dark:bg-gray-800/20">
                                {uploadedImage ? <img src={uploadedImage} className="max-h-full max-w-full object-contain rounded-md" /> : <span className="text-theme-secondary">Tap to upload an image</span>}
                            </div>
                            <input type="file" ref={fileInputRef} onChange={handleImageUpload} accept="image/*" className="hidden" />
                            <button onClick={toggleListening} disabled={!recognition || !uploadedImage} className={`w-full flex items-center justify-center bg-blue-500 text-white font-semibold py-3 rounded-lg shadow-lg disabled:bg-gray-400`}>
                                {/* This is an SVG for the microphone icon */}
                                <svg className="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2S10 4.9 10 6v6c0 1.1.9 2 2 2zM17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                                <span className="ml-2">{isListening ? 'Listening...' : (speechText ? `"${speechText}"` : 'Ask about this image')}</span>
                            </button>
                        </div>
                    ) : (
                        <button onClick={toggleListening} disabled={!recognition} className={`w-32 h-32 rounded-full transition-all shadow-lg flex-shrink-0 flex items-center justify-center ${isListening ? 'bg-red-500 scale-110' : 'bg-blue-500'}`}>
                            {/* ############  NEW, CORRECTED ICON SVG  ############ */}
                            <svg className="w-16 h-16 text-white" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2S10 4.9 10 6v6c0 1.1.9 2 2 2zm5-3c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"></path>
                            </svg>
                        </button>
                    )}
                </div>

                <div className="space-y-4 flex-shrink-0">
                    <div className="h-6">
                      {isAiProcessing && <p className="text-theme-secondary animate-pulse">{statusMessage}</p>}
                    </div>
                    { mode !== 'explain' &&
                        <div className="iphone-glass-effect p-4 rounded-xl text-left min-h-[4rem] border border-gray-400/20 dark:border-gray-600/30">
                            <h2 className="text-sm font-bold text-theme-primary mb-1">Your Request:</h2>
                            <p className="text-theme-secondary">{speechText || <span className="italic opacity-70">...</span>}</p>
                        </div>
                    }
                    {answer && (
                        <div className={`relative iphone-glass-effect p-4 rounded-xl text-left border border-gray-400/20 dark:border-gray-600/30`}>
                          <h2 className="text-lg font-bold text-theme-primary mb-2">AI Answer:</h2>
                          <p className="text-theme-secondary text-lg" style={{ whiteSpace: 'pre-wrap' }}>{answer}</p>
                        </div>
                    )}
                </div>
            </div>
          );

          const HistoryView = () => (
            <div className="flex flex-col h-full">
                <h1 className="text-3xl font-bold text-theme-primary mb-4 pt-8 sm:pt-0">History</h1>
                <div className="history-panel flex-grow">
                    {history.length > 0 ? history.map(item => (
                        <div key={item.id} onClick={() => restoreFromHistory(item)} className="text-left p-3 mb-2 rounded-lg bg-white/50 dark:bg-gray-800/30 cursor-pointer">
                            <p className="font-semibold text-theme-primary truncate">{item.question}</p>
                            <p className="text-sm text-theme-secondary mt-1 opacity-80 truncate">{item.answer}</p>
                        </div>
                    )) : <p className="text-theme-secondary">No history yet.</p>}
                </div>
            </div>
          );
          
          const SettingsView = () => (
            <div className="flex flex-col h-full">
                <h1 className="text-3xl font-bold text-theme-primary mb-4 pt-8 sm:pt-0">Settings</h1>
                <div className="space-y-4 text-left">
                    <div className="flex justify-between items-center p-3 rounded-lg bg-white/50 dark:bg-gray-800/30">
                        <label className="font-semibold text-theme-primary">Dark Mode</label>
                        <button onClick={toggleTheme} className="px-4 py-2 text-sm rounded-lg font-semibold bg-gray-300 dark:bg-gray-700">{isDarkMode ? 'Disable' : 'Enable'}</button>
                    </div>
                     <div className="flex justify-between items-center p-3 rounded-lg bg-white/50 dark:bg-gray-800/30">
                        <label className="font-semibold text-theme-primary">Conversation History</label>
                        <button onClick={clearHistory} className="px-4 py-2 text-sm rounded-lg font-semibold text-white bg-red-500">Clear</button>
                    </div>
                </div>
            </div>
          );

          return (
            <div className="min-h-screen flex items-stretch">
              <div className="w-full flex flex-col text-center sm:max-w-sm mx-auto sm:my-8 sm:rounded-3xl sm:shadow-lg iphone-glass-effect sm:border border-gray-400/20 dark:border-gray-600/30 p-6 relative">
                 <div className="absolute top-4 right-4 flex space-x-2 z-10">
                    <button onClick={() => setCurrentView(currentView === 'history' ? 'main' : 'history')} className="p-2 rounded-full bg-white/50 dark:bg-gray-800/50 text-theme-secondary">📜</button>
                    <button onClick={() => setCurrentView(currentView === 'settings' ? 'main' : 'settings')} className="p-2 rounded-full bg-white/50 dark:bg-gray-800/50 text-theme-secondary">⚙️</button>
                </div>

                {currentView === 'main' && <MainView />}
                {currentView === 'history' && <HistoryView />}
                {currentView === 'settings' && <SettingsView />}
              </div>
            </div>
          );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
